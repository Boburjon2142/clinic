{% extends 'base.html' %}
{% block title %}To'lov{% endblock %}
{% block content %}
  <h3 class="mb-3">To'lov â€” {{ appointment.patient.full_name }} ({{ appointment.doctor.full_name }})</h3>
  <form method="post" class="card card-body" style="max-width: 520px; margin: 0 auto;">
    {% csrf_token %}
    <div class="mb-2">
      <label class="form-label">Xizmat narxi</label>
      <input class="form-control" value="{{ appointment.service_price }} so'm" readonly>
    </div>
    <div class="mb-2">
      {{ form.as_p }}
    </div>
    <div class="mt-2">
      <button class="btn btn-primary">To'lovni saqlash va kvitansiya</button>
      <a class="btn btn-secondary" href="/appointments/">Bekor qilish</a>
    </div>
  </form>
  <script>
    (function(){
      const form = document.querySelector('form');
      if (!form) return;
      let win = null;
      // Listen for receiptPrinted message and redirect to home
      window.addEventListener('message', function(e){
        try{
          const d = e && e.data; if (d && d.type === 'receiptPrinted'){
            try { if (win && !win.closed) win.close(); } catch (err) {}
            try { window.location.href = '/'; } catch (err) {}
          }
        }catch(err){}
      });
      form.addEventListener('submit', function(){
        try { win = window.open('', 'paymentReceipt', 'width=520,height=800'); form.setAttribute('target', 'paymentReceipt'); } catch(e) {}
        setTimeout(function(){ form.removeAttribute('target'); }, 1500);
      });
      // Also allow Ctrl+Enter to submit and print
      form.addEventListener('keydown', function(e){
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); form.requestSubmit(); }
      });
    })();
  </script>
{% endblock %}
